<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entra√Ænement garde debout ‚Äî Syst√®me complet</title>
  <style>
    :root{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
      --primary:#3b82f6;
      --primary-hover:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#e6eef8;padding:20px}
    .card{width:min(900px,100%);background:linear-gradient(180deg,#1e293b, #0f172a);padding:30px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.05)}
    h1{margin:0 0 8px;font-size:28px;background:linear-gradient(90deg,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    p{margin:4px 0 20px;color:#94a3b8;font-size:15px}
    .main-content{display:grid;grid-template-columns:1fr 1fr;gap:30px}
    @media(max-width:768px){
      .main-content{grid-template-columns:1fr}
      .card{padding:20px}
    }
    .result-section{background:rgba(59,130,246,.05);padding:24px;border-radius:12px;border:1px solid rgba(59,130,246,.2);position:relative}
    .status-display{text-align:center;margin:20px 0}
    .status-icon{font-size:80px;margin:20px 0;animation:float 3s ease-in-out infinite}
    @keyframes float{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-10px)}
    }
    .status-text{font-size:24px;font-weight:600;color:#60a5fa;margin:12px 0}
    .elapsed-time{font-size:18px;color:#94a3b8;font-family:monospace;letter-spacing:2px}
    .controls{display:flex;flex-direction:column;gap:12px;margin-top:16px}
    button{padding:14px 24px;border-radius:10px;border:0;cursor:pointer;font-weight:600;font-size:16px;transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:8px}
    button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
    button:active{transform:translateY(0)}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-primary{background:var(--primary);color:white}
    .btn-primary:hover:not(:disabled){background:var(--primary-hover)}
    .btn-danger{background:var(--danger);color:white}
    .btn-danger:hover:not(:disabled){background:#dc2626}
    .btn-success{background:var(--success);color:white}
    .btn-success:hover{background:#059669}
    .btn-warning{background:var(--warning);color:white}
    .btn-warning:hover{background:#d97706}
    .btn-secondary{background:rgba(100,116,139,.2);color:#e2e8f0;border:1px solid rgba(255,255,255,.1)}
    .btn-secondary:hover{background:rgba(100,116,139,.3)}
    .btn-night{background:#7c3aed;color:white}
    .btn-night:hover{background:#6d28d9}
    .settings{background:rgba(15,23,42,.5);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,.05)}
    .setting-group{margin-bottom:16px}
    .setting-group:last-child{margin-bottom:0}
    label{display:block;margin-bottom:6px;color:#cbd5e1;font-size:14px;font-weight:500}
    .checkbox-label{display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px;border-radius:8px;transition:background .2s}
    .checkbox-label:hover{background:rgba(255,255,255,.03)}
    input[type=checkbox]{width:18px;height:18px;cursor:pointer;accent-color:var(--primary)}
    input[type=text],input[type=number],select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(15,23,42,.6);color:#e2e8f0;font-size:14px;transition:all .2s}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    textarea{width:100%;height:120px;border-radius:8px;padding:12px;margin-top:8px;border:1px solid rgba(255,255,255,.1);background:rgba(15,23,42,.6);color:#e2e8f0;font-family:monospace;font-size:13px;resize:vertical}
    .instructions{background:rgba(15,23,42,.3);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,.05)}
    .instructions h3{margin:0 0 12px;color:#60a5fa;font-size:18px}
    .instructions ul{margin:0;padding-left:20px;line-height:1.8;color:#94a3b8}
    .instructions li{margin-bottom:8px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
    .stat-card{background:rgba(15,23,42,.4);padding:12px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,.05)}
    .stat-value{font-size:24px;font-weight:700;color:#60a5fa}
    .stat-label{font-size:12px;color:#94a3b8;margin-top:4px}
    footer{margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,.05);color:#64748b;font-size:13px;text-align:center}
    .icon{width:20px;height:20px;display:inline-block}
    .toast{position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);opacity:0;transform:translateY(-20px);transition:all .3s ease;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .questionnaire{display:none;animation:fadeIn .3s ease}
    .questionnaire.active{display:block}
    .questionnaire h3{margin:0 0 16px;color:#60a5fa;font-size:18px;text-align:center}
    .questionnaire-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .phase-indicator{text-align:center;padding:12px;background:rgba(59,130,246,.1);border-radius:8px;margin-bottom:16px;border:1px solid rgba(59,130,246,.2)}
    .phase-indicator.active{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3)}
    .phase-indicator.waiting{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3);animation:pulse-waiting 2s infinite}
    @keyframes pulse-waiting{
      0%,100%{opacity:1}
      50%{opacity:.7}
    }
    .alert-flash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ef4444;
      z-index: 9999;
      display: none;
      animation: flash 0.5s ease-in-out infinite;
    }
    .alert-flash.active {
      display: block;
    }
    @keyframes flash {
      0%, 100% { opacity: 0; }
      50% { opacity: 0.9; }
    }
    .alert-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      color: #000;
      padding: 40px;
      border-radius: 20px;
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      z-index: 10000;
      display: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .alert-message.active {
      display: block;
      animation: bounce 0.5s ease-in-out infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    .level-badge{display:inline-block;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;background:rgba(59,130,246,.2);color:#60a5fa;margin-left:8px}
    .session-info{background:rgba(124,58,237,.1);border:1px solid rgba(124,58,237,.3);padding:12px;border-radius:8px;margin-bottom:12px;font-size:13px;color:#c4b5fd}
    .session-info strong{color:#a78bfa}
  </style>
</head>
<body>
  <div class="alert-flash" id="alertFlash"></div>
  <div class="alert-message" id="alertMessage">
    üîî TEMPS √âCOUL√â ! üîî<br>
    <span style="font-size:24px">Appuyez pour arr√™ter</span>
  </div>
  
  <audio id="beepAudio" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
  </audio>
  
  <main class="card">
    <h1>üö™ Entra√Ænement garde debout</h1>
    <p>Syst√®me d'entra√Ænement progressif avec √©chauffement et √©tirements</p>

    <div class="main-content">
      <div>
        <div class="result-section">
          <div class="phase-indicator" id="phaseIndicator">
            <strong>S√©lectionnez votre niveau</strong>
          </div>
          
          <div id="sessionInfo" class="session-info" style="display:none">
            <strong>Session en cours :</strong> <span id="sessionType"></span><br>
            <strong>Dur√©e :</strong> <span id="sessionDuration"></span>
          </div>
          
          <div class="status-display">
            <div class="status-icon" id="statusIcon">‚è±Ô∏è</div>
            <div class="status-text" id="statusText">En attente</div>
            <div class="elapsed-time" id="elapsedTime"></div>
          </div>
          
          <div class="controls" id="levelSelection">
            <label style="text-align:center;margin-bottom:8px">Choisissez votre niveau d'entra√Ænement</label>
            <button id="level1" class="btn-primary">
              Niveau 1 <span class="level-badge">2-5h</span>
            </button>
            <button id="level2" class="btn-primary">
              Niveau 2 <span class="level-badge">4-7h</span>
            </button>
            <button id="level3" class="btn-primary">
              Niveau 3 <span class="level-badge">7-9h</span>
            </button>
            <button id="level4" class="btn-primary">
              Niveau 4 <span class="level-badge">9h fixe</span>
            </button>
            <button id="level5" class="btn-primary">
              Niveau 5 <span class="level-badge">2-9h</span>
            </button>
          </div>

          <div class="controls" id="warmupSelection" style="display:none">
            <button id="startWithWarmup" class="btn-warning">
              üî• Commencer avec √©chauffement (20-45 min)
            </button>
            <button id="startWithoutWarmup" class="btn-primary">
              ‚ñ∂Ô∏è Commencer directement
            </button>
          </div>

          <div class="controls" id="runningControls" style="display:none">
            <button id="stop" class="btn-danger">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="6" width="12" height="12"/>
              </svg>
              Arr√™ter l'entra√Ænement
            </button>
          </div>

          <div class="questionnaire" id="questionnaire">
            <h3>üí¨ Comment s'est pass√© l'entra√Ænement ?</h3>
            <div class="questionnaire-buttons">
              <button class="btn-success" id="btnSuccess">
                ‚úÖ Tenu jusqu'au bout
              </button>
              <button class="btn-danger" id="btnFailed">
                ‚ùå Abandonn√© avant
              </button>
              <button class="btn-warning" id="btnPartial">
                ‚ö†Ô∏è Tenu partiellement
              </button>
              <button class="btn-secondary" id="btnSkip">
                ‚è≠Ô∏è Ne pas partager
              </button>
            </div>
          </div>

          <div class="controls" id="stretchingOption" style="display:none">
            <button id="startStretching" class="btn-warning">
              üßò Faire les √©tirements (20-45 min)
            </button>
            <button id="skipStretching" class="btn-secondary">
              ‚è≠Ô∏è Passer les √©tirements
            </button>
          </div>

          <div class="controls" id="nightTrainingOption" style="display:none">
            <button id="startNightTraining" class="btn-night">
              üåô 2e entra√Ænement nocturne (1-3h)
            </button>
          </div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Sessions totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statLast">‚Äî</div>
            <div class="stat-label">Derni√®re dur√©e</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statSuccess">0%</div>
            <div class="stat-label">Taux de r√©ussite</div>
          </div>
        </div>

        <div class="settings" style="margin-top:20px">
          <div class="setting-group">
            <label>Num√©ro destinataire (format international, sans +)</label>
            <input type="text" id="phone" value="33783204184" placeholder="337..." />
          </div>

          <div class="setting-group">
            <label class="checkbox-label">
              <input type="checkbox" id="includeDate" checked/>
              <span>Inclure la date et l'heure</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="soundAlert" checked/>
              <span>Signal sonore √† la fin</span>
            </label>
          </div>

          <div class="setting-group">
            <label>Aper√ßu du message</label>
            <textarea id="message" readonly></textarea>
          </div>
        </div>
      </div>

      <div>
        <div class="instructions">
          <h3>‚ö†Ô∏è Avant de commencer</h3>
          <ul>
            <li><strong>üîå Branchez votre t√©l√©phone</strong> ‚Äî L'entra√Ænement peut durer jusqu'√† 9h</li>
            <li><strong>üîä Testez TOUT</strong> ‚Äî Utilisez le bouton ci-dessous</li>
            <li><strong>üì± Volume suffisant</strong> ‚Äî Assurez-vous d'entendre le signal de fin</li>
            <li><strong>üîî Signal multiple :</strong> Son + Vibration (Android) + Flash rouge</li>
            <li><strong>üì≤ iPhone :</strong> Son + Flash rouge (pas de vibration possible)</li>
          </ul>
          <button id="testSound" class="btn-warning" style="width:100%;margin-top:12px">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
              <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
            </svg>
            üîä Tester TOUT (son + vibration + flash)
          </button>
        </div>

        <div class="instructions" style="margin-top:16px">
          <h3>üìä Syst√®me de niveaux</h3>
          <ul>
            <li><strong>Niveau 1 :</strong> 2-5h (d√©butant)</li>
            <li><strong>Niveau 2 :</strong> 4-7h (interm√©diaire)</li>
            <li><strong>Niveau 3 :</strong> 7-9h (avanc√©)</li>
            <li><strong>Niveau 4 :</strong> 9h fixes (expert)</li>
            <li><strong>Niveau 5 :</strong> 2-9h (al√©atoire complet)</li>
          </ul>
        </div>

        <div class="instructions" style="margin-top:16px">
          <h3>üî• √âchauffement & √âtirements</h3>
          <ul>
            <li><strong>√âchauffement :</strong> 20-45 min avant l'entra√Ænement</li>
            <li><strong>√âtirements :</strong> 20-45 min apr√®s l'entra√Ænement</li>
            <li><strong>Probabilit√©s :</strong>
              <ul style="margin-top:4px">
                <li>60% ‚Üí Plus de 40 min</li>
                <li>30% ‚Üí 30-40 min</li>
                <li>10% ‚Üí 20-30 min</li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="instructions" style="margin-top:16px">
          <h3>üåô Entra√Ænement nocturne</h3>
          <ul>
            <li><strong>Disponible si :</strong> Entra√Ænement de 2-4h effectu√©</li>
            <li><strong>Dur√©e :</strong> 1-3h suppl√©mentaires</li>
            <li><strong>But :</strong> Entra√Ænement surprise sur demande</li>
          </ul>
        </div>
      </div>
    </div>

    <footer>
      Guard-Trainer v2.0 ‚Äî Syst√®me d'entra√Ænement complet üí™ | üîí Anti-veille activ√©
    </footer>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    const stats = {
      total: 0,
      successes: 0,
      durations: [],
      lastTrainingDuration: 0
    };

    let targetDuration = 0;
    let startTime = 0;
    let timerInterval = null;
    let audioContext = null;
    let wakeLock = null;
    let audioBuffer = null;
    let selectedLevel = 0;
    let currentPhase = 'idle';
    let trainingPhase = 'main';

    const beepAudio = document.getElementById('beepAudio');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const elapsedTime = document.getElementById('elapsedTime');
    const msgEl = document.getElementById('message');
    const stopBtn = document.getElementById('stop');
    const levelSelection = document.getElementById('levelSelection');
    const warmupSelection = document.getElementById('warmupSelection');
    const runningControls = document.getElementById('runningControls');
    const questionnaire = document.getElementById('questionnaire');
    const stretchingOption = document.getElementById('stretchingOption');
    const nightTrainingOption = document.getElementById('nightTrainingOption');
    const phaseIndicator = document.getElementById('phaseIndicator');
    const soundAlert = document.getElementById('soundAlert');
    const includeDate = document.getElementById('includeDate');
    const phoneInput = document.getElementById('phone');
    const statTotal = document.getElementById('statTotal');
    const statLast = document.getElementById('statLast');
    const statSuccess = document.getElementById('statSuccess');
    const sessionInfo = document.getElementById('sessionInfo');
    const sessionType = document.getElementById('sessionType');
    const sessionDuration = document.getElementById('sessionDuration');

    const btnSuccess = document.getElementById('btnSuccess');
    const btnFailed = document.getElementById('btnFailed');
    const btnPartial = document.getElementById('btnPartial');
    const btnSkip = document.getElementById('btnSkip');
    const testSoundBtn = document.getElementById('testSound');
    const startWithWarmup = document.getElementById('startWithWarmup');
    const startWithoutWarmup = document.getElementById('startWithoutWarmup');
    const startStretching = document.getElementById('startStretching');
    const skipStretching = document.getElementById('skipStretching');
    const startNightTraining = document.getElementById('startNightTraining');
    const alertFlash = document.getElementById('alertFlash');
    const alertMessage = document.getElementById('alertMessage');
    
    const level1Btn = document.getElementById('level1');
    const level2Btn = document.getElementById('level2');
    const level3Btn = document.getElementById('level3');
    const level4Btn = document.getElementById('level4');
    const level5Btn = document.getElementById('level5');

    function randomDuration(minHours, maxHours){
      const minMs = minHours * 3600000;
      const maxMs = maxHours * 3600000;
      return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
    }

    function generateWarmupDuration(){
      const rand = Math.random() * 100;
      if(rand < 60){
        return randomDuration(40/60, 45/60);
      } else if(rand < 90){
        return randomDuration(30/60, 40/60);
      } else {
        return randomDuration(20/60, 30/60);
      }
    }

    function formatDuration(ms){
      const hours = Math.floor(ms / 3600000);
      const minutes = Math.floor((ms % 3600000) / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      return `${hours}h ${minutes.toString().padStart(2,'0')}m ${seconds.toString().padStart(2,'0')}s`;
    }

    function formatDurationShort(ms){
      const hours = Math.floor(ms / 3600000);
      const minutes = Math.floor((ms % 3600000) / 60000);
      if(hours > 0 && minutes > 0) return `${hours}h${minutes}m`;
      if(hours > 0) return `${hours}h`;
      return `${minutes}m`;
    }

    function showToast(message){
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function generateAudioBuffer(){
      if(!audioContext){
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      const sampleRate = audioContext.sampleRate;
      const duration = 5.5;
      const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
      const data = buffer.getChannelData(0);
      
      for(let repeat = 0; repeat < 5; repeat++){
        const startSample = Math.floor(repeat * sampleRate);
        
        for(let i = 0; i < sampleRate * 0.5; i++){
          const t = i / sampleRate;
          data[startSample + i] = Math.sin(2 * Math.PI * 800 * t) * 0.3 * Math.exp(-t * 2);
        }
        
        const secondBeepStart = startSample + Math.floor(sampleRate * 0.2);
        for(let i = 0; i < sampleRate * 0.5; i++){
          const t = i / sampleRate;
          if(secondBeepStart + i < data.length){
            data[secondBeepStart + i] = Math.sin(2 * Math.PI * 1000 * t) * 0.3 * Math.exp(-t * 2);
          }
        }
      }
      
      return buffer;
    }

    function updateStats(duration, success){
      stats.total++;
      if(success) stats.successes++;
      stats.durations.push(duration);
      stats.lastTrainingDuration = duration;
      
      statTotal.textContent = stats.total;
      statLast.textContent = formatDurationShort(duration);
      
      const successRate = stats.total > 0 ? Math.round((stats.successes / stats.total) * 100) : 0;
      statSuccess.textContent = successRate + '%';
    }

    function buildMessage(duration, result, wasCompleted, phaseType){
      let msg = `üö™ Entra√Ænement garde debout\n`;
      msg += `Type : ${phaseType}\n`;
      msg += `Dur√©e pr√©vue : ${formatDuration(duration)}\n`;
      msg += `R√©sultat : ${result}\n`;
      
      if(includeDate.checked){
        const date = new Date();
        const dateStr = date.toLocaleString('fr-FR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        msg += `üìÖ ${dateStr}\n`;
      }
      
      msg += `\n(Envoy√© via Guard-Trainer v2.0)`;
      return msg;
    }

    function openWhatsApp(phone, text){
      const encoded = encodeURIComponent(text);
      const waLink = `https://wa.me/${phone}?text=${encoded}`;
      window.open(waLink, '_blank');
    }

    function playBeep(){
      if(!soundAlert.checked) return;
      
      beepAudio.currentTime = 0;
      beepAudio.play().then(() => {
        console.log('Audio jou√© via HTML5');
        
        let playCount = 1;
        const interval = setInterval(() => {
          if(playCount < 5){
            beepAudio.currentTime = 0;
            beepAudio.play();
            playCount++;
          } else {
            clearInterval(interval);
          }
        }, 2000);
      }).catch(error => {
        console.error('Test audio √©chou√©:', error);
        showToast('‚ö†Ô∏è Son non disponible, mais vibration + flash activ√©s');
        fallbackWebAudio();
      });
      
      vibrate();
      showVisualAlert();
    }

    async function requestWakeLock(){
      try{
        if('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock released');
          });
        }
      }catch(err){
        console.error('Wake Lock error:', err);
      }
    }

    function releaseWakeLock(){
      if(wakeLock){
        wakeLock.release();
        wakeLock = null;
      }
    }

    function selectLevel(level){
      selectedLevel = level;
      levelSelection.style.display = 'none';
      warmupSelection.style.display = 'flex';
      phaseIndicator.innerHTML = '<strong>Niveau ' + level + ' s√©lectionn√©</strong> ‚Äî Commencer avec √©chauffement ?';
      showToast('‚úÖ Niveau ' + level + ' s√©lectionn√©');
    }

    function getLevelDuration(level){
      switch(level){
        case 1: return randomDuration(2, 5);
        case 2: return randomDuration(4, 7);
        case 3: return randomDuration(7, 9);
        case 4: return 9 * 3600000;
        case 5: return randomDuration(2, 9);
        default: return randomDuration(2, 9);
      }
    }

    async function startTraining(withWarmup){
      beepAudio.play().then(() => {
        beepAudio.pause();
        beepAudio.currentTime = 0;
      }).catch(e => console.log('Audio pre-init:', e));
      
      if(!audioContext){
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(audioContext.state === 'suspended'){
        await audioContext.resume();
      }
      
      await requestWakeLock();
      
      if(withWarmup){
        trainingPhase = 'warmup';
        targetDuration = generateWarmupDuration();
        sessionType.textContent = '√âchauffement';
        statusIcon.textContent = 'üî•';
        statusText.textContent = '√âchauffement...';
        phaseIndicator.innerHTML = '<strong>√âchauffement en cours</strong> ‚Äî Pr√©parez-vous !';
      } else {
        trainingPhase = 'main';
        targetDuration = getLevelDuration(selectedLevel);
        sessionType.textContent = 'Entra√Ænement principal (Niveau ' + selectedLevel + ')';
        statusIcon.textContent = 'üö™';
        statusText.textContent = 'En garde...';
        phaseIndicator.innerHTML = '<strong>Entra√Ænement en cours</strong> ‚Äî Tenez la position !';
      }
      
      sessionDuration.textContent = '??:??';
      sessionInfo.style.display = 'block';
      
      startTime = Date.now();
      warmupSelection.style.display = 'none';
      runningControls.style.display = 'flex';
      phaseIndicator.classList.add('waiting');
      
      timerInterval = setInterval(() => {
        updateElapsedTime();
        
        if(Date.now() - startTime >= targetDuration){
          endTraining();
        }
      }, 1000);
      
      showToast('üöÄ ' + (withWarmup ? '√âchauffement' : 'Entra√Ænement') + ' d√©marr√© !');
    }

    function updateElapsedTime(){
      const elapsed = Date.now() - startTime;
      elapsedTime.textContent = formatDuration(elapsed);
    }

    function endTraining(){
      clearInterval(timerInterval);
      releaseWakeLock();
      
      playBeep();
      vibrate();
      showVisualAlert();
      
      if(trainingPhase === 'warmup'){
        statusIcon.textContent = '‚úÖ';
        statusText.textContent = '√âchauffement termin√© !';
        phaseIndicator.classList.remove('waiting');
        phaseIndicator.classList.add('active');
        phaseIndicator.innerHTML = '<strong>√âchauffement termin√©</strong> ‚Äî Pr√™t pour l\'entra√Ænement principal ?';
        
        runningControls.style.display = 'none';
        sessionInfo.style.display = 'none';
        
        setTimeout(() => {
          stopVisualAlert();
          startTraining(false);
        }, 3000);
        
      } else if(trainingPhase === 'main'){
        statusIcon.textContent = 'üîî';
        statusText.textContent = 'Temps √©coul√© !';
        phaseIndicator.classList.remove('waiting');
        phaseIndicator.classList.add('active');
        phaseIndicator.innerHTML = '<strong>Session termin√©e</strong> ‚Äî Comment s\'est-elle pass√©e ?';
        
        runningControls.style.display = 'none';
        questionnaire.classList.add('active');
        
      } else if(trainingPhase === 'stretching'){
        statusIcon.textContent = '‚úÖ';
        statusText.textContent = '√âtirements termin√©s !';
        phaseIndicator.classList.remove('waiting');
        phaseIndicator.classList.add('active');
        phaseIndicator.innerHTML = '<strong>√âtirements termin√©s</strong> ‚Äî Session compl√®te !';
        
        runningControls.style.display = 'none';
        sessionInfo.style.display = 'none';
        
        setTimeout(() => {
          stopVisualAlert();
          checkNightTrainingEligibility();
          resetToInitial();
        }, 3000);
        
      } else if(trainingPhase === 'night'){
        statusIcon.textContent = 'üåô';
        statusText.textContent = 'Entra√Ænement nocturne termin√© !';
        phaseIndicator.classList.remove('waiting');
        phaseIndicator.classList.add('active');
        phaseIndicator.innerHTML = '<strong>Entra√Ænement nocturne termin√©</strong> ‚Äî Bravo !';
        
        runningControls.style.display = 'none';
        questionnaire.classList.add('active');
      }
      
      showToast('‚è∞ Signal de fin !');
    }

    function stopTraining(){
      if(confirm('√ätes-vous s√ªr de vouloir arr√™ter ?')){
        clearInterval(timerInterval);
        releaseWakeLock();
        
        statusIcon.textContent = 'üõë';
        statusText.textContent = 'Arr√™t√©';
        phaseIndicator.classList.remove('waiting');
        phaseIndicator.classList.add('active');
        phaseIndicator.innerHTML = '<strong>Session interrompue</strong>';
        
        runningControls.style.display = 'none';
        sessionInfo.style.display = 'none';
        
        setTimeout(() => {
          resetToInitial();
        }, 2000);
        
        showToast('‚è∏Ô∏è Arr√™t√©');
      }
    }

    function resetToInitial(){
      stopVisualAlert();
      levelSelection.style.display = 'flex';
      warmupSelection.style.display = 'none';
      runningControls.style.display = 'none';
      questionnaire.classList.remove('active');
      stretchingOption.style.display = 'none';
      nightTrainingOption.style.display = 'none';
      sessionInfo.style.display = 'none';
      phaseIndicator.classList.remove('active', 'waiting');
      phaseIndicator.innerHTML = '<strong>S√©lectionnez votre niveau</strong>';
      
      statusIcon.textContent = '‚è±Ô∏è';
      statusText.textContent = 'En attente';
      elapsedTime.textContent = '';
      selectedLevel = 0;
      trainingPhase = 'main';
    }

    function handleResult(resultEmoji, resultText, wasSuccess){
      const phaseLabel = trainingPhase === 'night' ? 'Entra√Ænement nocturne' : 'Entra√Ænement principal';
      const message = buildMessage(targetDuration, resultEmoji + ' ' + resultText, wasSuccess, phaseLabel);
      msgEl.value = message;

      updateStats(targetDuration, wasSuccess);

      const phone = phoneInput.value.trim();
      if(!phone){
        showToast('‚ö†Ô∏è Veuillez renseigner un num√©ro de t√©l√©phone');
        return;
      }

      showToast('üì± Ouverture de WhatsApp...');
      setTimeout(() => {
        openWhatsApp(phone, message);
        
        if(trainingPhase === 'main'){
          questionnaire.classList.remove('active');
          stretchingOption.style.display = 'flex';
          phaseIndicator.innerHTML = '<strong>Faire les √©tirements ?</strong>';
        } else {
          checkNightTrainingEligibility();
          resetToInitial();
        }
      }, 500);
    }

    function checkNightTrainingEligibility(){
      const durationHours = stats.lastTrainingDuration / 3600000;
      if(durationHours >= 2 && durationHours <= 4){
        nightTrainingOption.style.display = 'flex';
        showToast('üåô Entra√Ænement nocturne disponible');
      }
    }

    async function startStretching(){
      trainingPhase = 'stretching';
      targetDuration = generateWarmupDuration();
      
      await requestWakeLock();
      
      stretchingOption.style.display = 'none';
      runningControls.style.display = 'flex';
      
      sessionType.textContent = '√âtirements';
      sessionDuration.textContent = '??:??';
      sessionInfo.style.display = 'block';
      
      statusIcon.textContent = 'üßò';
      statusText.textContent = '√âtirements...';
      phaseIndicator.innerHTML = '<strong>√âtirements en cours</strong> ‚Äî D√©tendez-vous !';
      phaseIndicator.classList.add('waiting');
      
      startTime = Date.now();
      
      timerInterval = setInterval(() => {
        updateElapsedTime();
        
        if(Date.now() - startTime >= targetDuration){
          endTraining();
        }
      }, 1000);
      
      showToast('üßò √âtirements d√©marr√©s');
    }

    async function startNightTraining(){
      trainingPhase = 'night';
      targetDuration = randomDuration(1, 3);
      
      await requestWakeLock();
      
      nightTrainingOption.style.display = 'none';
      runningControls.style.display = 'flex';
      
      sessionType.textContent = 'Entra√Ænement nocturne';
      sessionDuration.textContent = '??:??';
      sessionInfo.style.display = 'block';
      
      statusIcon.textContent = 'üåô';
      statusText.textContent = 'Entra√Ænement nocturne...';
      phaseIndicator.innerHTML = '<strong>Entra√Ænement nocturne</strong> ‚Äî Sur ordre de l\'entra√Æneur !';
      phaseIndicator.classList.add('waiting');
      
      startTime = Date.now();
      
      timerInterval = setInterval(() => {
        updateElapsedTime();
        
        if(Date.now() - startTime >= targetDuration){
          endTraining();
        }
      }, 1000);
      
      showToast('üåô Entra√Ænement nocturne d√©marr√©');
    }

    stopBtn.addEventListener('click', stopTraining);
    testSoundBtn.addEventListener('click', testSound);

    level1Btn.addEventListener('click', () => selectLevel(1));
    level2Btn.addEventListener('click', () => selectLevel(2));
    level3Btn.addEventListener('click', () => selectLevel(3));
    level4Btn.addEventListener('click', () => selectLevel(4));
    level5Btn.addEventListener('click', () => selectLevel(5));

    startWithWarmup.addEventListener('click', () => startTraining(true));
    startWithoutWarmup.addEventListener('click', () => startTraining(false));
    startStretching.addEventListener('click', startStretching);
    skipStretching.addEventListener('click', () => {
      stretchingOption.style.display = 'none';
      checkNightTrainingEligibility();
      resetToInitial();
    });
    startNightTraining.addEventListener('click', startNightTraining);

    btnSuccess.addEventListener('click', () => handleResult('‚úÖ', 'Tenu jusqu\'au bout', true));
    btnFailed.addEventListener('click', () => handleResult('‚ùå', 'Abandonn√© avant', false));
    btnPartial.addEventListener('click', () => handleResult('‚ö†Ô∏è', 'Tenu partiellement', false));
    
    btnSkip.addEventListener('click', () => {
      showToast('‚è≠Ô∏è Session non partag√©e');
      if(trainingPhase === 'main'){
        questionnaire.classList.remove('active');
        stretchingOption.style.display = 'flex';
      } else {
        checkNightTrainingEligibility();
        resetToInitial();
      }
    });

    document.addEventListener('visibilitychange', async () => {
      if(wakeLock !== null && document.visibilityState === 'visible'){
        await requestWakeLock();
      }
    });
  </script>
</body>
</html>epAudio.play();
            playCount++;
          } else {
            clearInterval(interval);
          }
        }, 2000);
      }).catch(error => {
        console.error('Erreur audio HTML5:', error);
        fallbackWebAudio();
      });
    }

    function fallbackWebAudio(){
      try{
        if(!audioContext){
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        if(audioContext.state === 'suspended'){
          audioContext.resume();
        }
        
        if(!audioBuffer){
          audioBuffer = generateAudioBuffer();
        }
        
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start(0);
      }catch(e){
        console.error('Fallback audio error:', e);
      }
    }

    function vibrate(){
      if('vibrate' in navigator){
        const pattern = [200, 100, 200, 100, 200, 300, 200, 100, 200, 100, 200];
        for(let i = 0; i < 5; i++){
          setTimeout(() => navigator.vibrate(pattern), i * 2000);
        }
      }
    }

    function showVisualAlert(){
      alertFlash.classList.add('active');
      alertMessage.classList.add('active');
      
      alertMessage.addEventListener('click', stopVisualAlert);
      alertFlash.addEventListener('click', stopVisualAlert);
    }

    function stopVisualAlert(){
      alertFlash.classList.remove('active');
      alertMessage.classList.remove('active');
    }

    function testSound(){
      showToast('üîä Test complet : Son + Vibration + Flash');
      
      beepAudio.currentTime = 0;
      beepAudio.play().then(() => {
        console.log('Test audio r√©ussi');
        
        let playCount = 1;
        const interval = setInterval(() => {
          if(playCount < 5){
            beepAudio.currentTime = 0;
            be
