<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Entra√Ænement Porte v6.1</title>
  <style>
    :root {
      --primary: #3b82f6; 
      --success: #10b981; 
      --danger: #ef4444; 
      --warning: #f59e0b;
      --whatsapp: #25D366;
      --text-main: #e2e8f0; 
      --text-muted: #94a3b8;
      --coach-bg: rgba(59, 130, 246, 0.15);
      --punish-bg: #450a0a;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; margin: 0;
      background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
      color: var(--text-main); font-family: system-ui, -apple-system, sans-serif;
      padding: 16px; overflow-x: hidden;
    }

    /* Mode OLED */
    body.oled-mode { background: #000000; cursor: none; }
    body.oled-mode .card, body.oled-mode h1, body.oled-mode p, body.oled-mode .info-alert, body.oled-mode .coach-message { opacity: 0; pointer-events: none; }
    body.oled-mode .oled-overlay { display: flex; }

    .oled-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #000; z-index: 9999;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      color: #333;
      user-select: none;
    }
    .oled-touch-area { width: 100%; height: 100%; position: absolute; cursor: pointer; }
    .oled-icon { font-size: 5rem; opacity: 0.2; animation: breathe 4s infinite; }

    .card {
      width: min(550px, 100%);
      background: rgba(30, 41, 59, 0.85);
      padding: 30px; border-radius: 20px;
      box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding-bottom: 40px;
      backdrop-filter: blur(10px);
      transition: background 0.5s;
    }
    
    /* Mode Punition Visuelle */
    body.mode-punish .card { background: rgba(69, 10, 10, 0.9); border-color: #ef4444; }
    body.mode-punish h1 { background: none; color: #ef4444; -webkit-text-fill-color: #ef4444; }

    h1 { margin: 0 0 6px; font-size: 1.8rem; text-align: center; background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    p.subtitle { margin: 0 0 15px; color: var(--text-muted); font-size: 0.9rem; text-align: center; letter-spacing: 1px; text-transform: uppercase; }

    /* ZONE COACH */
    .coach-message {
        background: var(--coach-bg);
        border-left: 4px solid #60a5fa;
        color: #dbeafe;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        font-style: italic;
        font-size: 0.95rem;
        line-height: 1.5;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none;
        animation: fadeIn 0.5s ease;
    }
    .coach-title {
        font-weight: bold;
        color: #60a5fa;
        font-size: 0.8rem;
        margin-bottom: 5px;
        text-transform: uppercase;
        display: block;
    }

    .info-alert {
        background: rgba(245, 158, 11, 0.15);
        border: 1px solid var(--warning);
        color: #fcd34d;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-size: 0.85rem;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .status-display { 
        text-align: center; margin: 0 0 15px; padding: 25px; 
        border-radius: 16px; background: rgba(255, 255, 255, 0.03); 
        border: 1px solid rgba(255, 255, 255, 0.05); 
        position: relative; overflow: hidden; 
    }
    
    .status-icon { font-size: 56px; display: block; margin-bottom: 8px; transition: transform 0.3s; }
    .status-text { font-size: 1.4rem; font-weight: 700; color: #60a5fa; margin-bottom: 4px; text-transform: uppercase; }
    .elapsed-time { font-family: monospace; font-size: 2rem; letter-spacing: 2px; color: var(--text-main); font-weight: 700; }
    
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
    .active-ring::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; border-radius: 50%; border: 2px solid var(--primary); animation: pulse-ring 2s infinite; pointer-events: none; }

    .btn-grid { display: flex; flex-direction: column; gap: 12px; }
    button {
      padding: 16px 20px; border-radius: 14px; border: none; cursor: pointer;
      font-weight: 600; font-size: 1.05rem; color: white; 
      display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      touch-action: manipulation;
      transition: all 0.2s ease;
    }
    button:active { transform: scale(0.96); }
    
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); color: #1e293b; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); }
    .btn-night { background: linear-gradient(135deg, #4c1d95, #7c3aed); }
    .btn-oled { background: #000; border: 1px solid #333; margin-top: 5px; flex-direction: column; gap: 5px; }
    .btn-sleep { background: #312e81; border: 1px solid #6366f1; }

    .btn-whatsapp {
        background: var(--whatsapp);
        color: white;
        font-size: 1.2rem;
        padding: 20px;
        animation: pulse-green 2s infinite;
    }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }

    .badge { background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; margin-left: auto; }

    .settings-panel { margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    input[type=text], input[type=password], input[type=number], input[type=time] { width: 100%; background: rgba(15,23,42,0.6); border: 1px solid rgba(255,255,255,0.1); padding: 14px; border-radius: 10px; color: white; margin-bottom: 12px; font-size: 1rem; }
    
    .checkbox-row { display: flex; justify-content: space-around; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted); }
    .checkbox-label { display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 8px; transition: background 0.2s; }
    input[type="checkbox"] { transform: scale(1.3); accent-color: var(--primary); }

    /* Modal */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9000;
        display: none;
        align-items: center; justify-content: center;
        padding: 20px;
        backdrop-filter: blur(5px);
    }
    .modal-card {
        background: #1e293b;
        border: 1px solid rgba(59, 130, 246, 0.3);
        padding: 30px;
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        animation: fadeIn 0.3s ease;
    }
    .modal-title { font-size: 1.4rem; color: white; margin-bottom: 10px; font-weight: bold; }
    .modal-text { color: #94a3b8; margin-bottom: 25px; line-height: 1.5; }

    .fullscreen-alert {
      position: fixed; inset: 0; background: var(--danger); z-index: 10000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      display: none; padding: 20px;
    }
    .fullscreen-alert.active { display: flex; animation: flash 0.5s infinite; }
    
    .alert-content { background: white; color: black; padding: 40px; width: 100%; max-width: 400px; border-radius: 20px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.6); }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.15; } 50% { transform: scale(1.1); opacity: 0.3; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #334155; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: 0.3s; z-index: 10001; width: max-content; }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .hidden { display: none !important; }

    /* Sleep Grid */
    .sleep-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>
<body>

<!-- Alert Layer -->
<div id="alertLayer" class="fullscreen-alert">
  <div class="alert-content">
    <div style="font-size: 60px;" id="alertIcon">üîî</div>
    <h2 style="font-size: 2rem; margin: 15px 0;" id="alertTitle">TERMIN√â</h2>
    <p id="alertMsg" style="font-size: 1.2rem;">Appuyez pour continuer</p>
  </div>
</div>

<!-- OLED Saver Layer -->
<div id="oledOverlay" class="oled-overlay">
  <div class="oled-touch-area" id="oledTouchArea"></div>
  <div class="oled-icon">üö™</div>
  <p style="color: #444; margin-top: 20px;">Double-clic pour r√©veiller</p>
</div>

<!-- MODAL CHOIX -->
<div id="choiceModal" class="modal-overlay">
    <div class="modal-card">
        <div id="modalTitle" class="modal-title">Titre</div>
        <div id="modalText" class="modal-text">Texte</div>
        <div class="btn-grid">
            <button id="modalBtnYes" class="btn-primary">Accepter</button>
            <button id="modalBtnNo" class="btn-secondary">Refuser</button>
        </div>
    </div>
</div>

<main class="card">
  <h1>üö™ Entra√Ænement Porte</h1>
  <p class="subtitle">Version 6.1 ‚Ä¢ Discipline</p>

  <!-- Memo Chargeur -->
  <div class="info-alert" id="memoCharge">
      ‚ö° <strong>RAPPEL :</strong> Branchez l'appareil sur secteur pour √©viter la coupure !
  </div>

  <!-- Status -->
  <div id="statusPanel" class="status-display">
    <div class="status-icon" id="statusIcon">‚è±Ô∏è</div>
    <div class="status-text" id="statusText">En attente</div>
    <div class="elapsed-time" id="elapsedTime">00:00:00</div>
    <div id="phaseBadge" style="margin-top:8px; font-size:0.8rem; opacity:0.7">Pr√™t √† d√©marrer</div>
  </div>

  <!-- ZONE DE MESSAGE DU COACH -->
  <div id="coachBox" class="coach-message">
      <span class="coach-title">L'Entra√Æneur</span>
      <span id="coachText">...</span>
  </div>

  <!-- Ecran 1 : Choix Niveaux -->
  <div id="view-levels">
    <div class="btn-grid">
        <label style="color: #94a3b8; text-align: center; margin-bottom: 5px;">S√âLECTION MISSION :</label>
        <button onclick="app.triggerSelection(1)" class="btn-primary">Niveau 1 <span class="badge">2-5h</span></button>
        <button onclick="app.triggerSelection(2)" class="btn-primary">Niveau 2 <span class="badge">4-7h</span></button>
        <button onclick="app.triggerSelection(3)" class="btn-primary">Niveau 3 <span class="badge">7-9h</span></button>
        <button onclick="app.triggerSelection(4)" class="btn-primary">Niveau 4 <span class="badge">9h Fixe</span></button>
        <button onclick="app.triggerSelection(5)" class="btn-night">Niveau 5 <span class="badge">2-9h Chaos</span></button>
        <div style="border-top:1px solid #334155; margin:5px 0;"></div>
        <button onclick="app.setupSleepPunishment('nuitblanche')" class="btn-danger">üíÄ NUIT BLANCHE</button>
    </div>
  </div>

  <!-- Ecran 2 : En cours (Training) -->
  <div id="view-running" class="btn-grid hidden">
    <button onclick="app.addRunningTime(10)" class="btn-secondary" style="font-size: 0.9rem; padding: 10px; margin-bottom: 5px;">‚ûï Ajouter 10 min</button>
    
    <button onclick="app.toggleOledMode()" class="btn-oled" style="height: 120px; font-size: 1.3rem;">
        üåë √âTEINDRE √âCRAN
        <span style="font-size:0.8rem; font-weight:normal; color:#888;">(√âconomie Batterie)</span>
    </button>
    <div style="text-align:center; color:#ef4444; font-size:0.8rem; margin:10px 0; font-weight:bold;">‚ö†Ô∏è PAUSE INTERDITE</div>
    <button onclick="app.confirmStop()" class="btn-danger">üõë Abandonner</button>
  </div>

  <!-- Ecran 3 : R√©sultat Garde -->
  <div id="view-result" class="btn-grid hidden">
    <!-- Extension -->
    <div id="extension-area" style="padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom:15px;">
        <button onclick="app.extendSession(30)" class="btn-warning" style="border: 1px dashed #f59e0b; background: rgba(245, 158, 11, 0.1);">
            ‚åõ Rallonger (+30 min)
        </button>
    </div>

    <p style="text-align:center; color:white; margin:0">Que faire maintenant ?</p>
    
    <button onclick="app.setupSleepPunishment('challenge')" class="btn-sleep">
        üõèÔ∏è ENDORS-TOI VITE
        <span style="font-size:0.75rem; color:#a5b4fc; display:block">Timer Sommeil</span>
    </button>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button onclick="app.finish(true)" class="btn-success">‚úÖ R√©ussi</button>
        <button onclick="app.finish(false)" class="btn-danger">‚ùå √âchec</button>
    </div>
    
    <!-- Zone Whatsapp en bas -->
    <div id="whatsapp-area" class="hidden" style="margin-top:20px;">
        <button onclick="app.triggerWhatsapp()" class="btn-whatsapp" style="width:100%">üì≤ ENVOYER RAPPORT</button>
        <button onclick="app.resetUI()" class="btn-secondary" style="margin-top:10px; width:100%">Retour Menu</button>
    </div>
  </div>

  <!-- Ecran 4 : Setup Sleep Challenge -->
  <div id="view-sleep-setup" class="btn-grid hidden">
      <p style="text-align:center; color:#a5b4fc">Combien de temps pour t'endormir ?</p>
      <div class="sleep-grid">
          <button onclick="app.startSleepTimer(20)" class="btn-primary">20 min</button>
          <button onclick="app.startSleepTimer(15)" class="btn-primary">15 min</button>
          <button onclick="app.startSleepTimer(10)" class="btn-primary">10 min</button>
          <button onclick="app.startSleepTimer(5)" class="btn-danger">5 min üòà</button>
      </div>
      <p style="font-size:0.85rem; color:#94a3b8; text-align:center; margin-top:15px;">
          "Si tu ne dors pas dans ce d√©lai, tu reviens ici et tu seras puni."
      </p>
      <button onclick="app.showResultScreen()" class="btn-secondary">Retour</button>
  </div>

  <!-- Ecran 5 : Sleep Running -->
  <div id="view-sleep-run" class="btn-grid hidden">
      <div style="padding:40px 0; text-align:center;">
          <div style="font-size:3rem;">üí§</div>
          <p>Essaie de dormir...</p>
      </div>
      <button onclick="app.toggleOledMode()" class="btn-oled" style="height: 100px;">üåë √âCRAN NOIR</button>
      <button onclick="app.failSleep('voluntary')" class="btn-danger" style="margin-top:20px">
          üëÄ SOMMEIL IMPOSSIBLE
          <span style="font-size:0.75rem; display:block">Je n'y arrive pas, je me rends.</span>
      </button>
  </div>

  <!-- Ecran 6 : Sleep Fail Reporting -->
  <div id="view-sleep-report" class="btn-grid hidden">
      <h2 style="color:#ef4444; text-align:center">SIGNALEMENT</h2>
      <p style="text-align:center; font-size:0.9rem">"Je n‚Äôai pas r√©ussi √† m‚Äôendormir. Je me signale comme √©veill√© et m√©rite d‚Äô√™tre puni."</p>
      
      <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin:10px 0;">
          <label style="display:block; margin-bottom:5px; color:#cbd5e1">Heure de ton r√©veil :</label>
          <input type="time" id="wakeupTime" style="font-size:1.5rem; text-align:center">
      </div>

      <button onclick="app.calculatePunishment()" class="btn-danger">VALIDER LA PUNITION</button>
  </div>

  <!-- Ecran 7 : PUNITION -->
  <div id="view-punishment" class="hidden">
      <div style="text-align:center; border:2px solid #ef4444; padding:20px; border-radius:15px; background:rgba(69,10,10,0.8);">
          <h1 style="color:#ef4444; margin-bottom:20px">üíÄ PUNITION</h1>
          <p id="punish-msg" style="font-size:1.1rem; line-height:1.5; color:#fca5a5; margin-bottom:20px">...</p>
          <div style="font-size:2.5rem; font-weight:bold; color:white; margin:20px 0" id="punish-timer">00:00:00</div>
          <p style="font-size:0.9rem; color:#94a3b8">Restez debout jusqu'au r√©veil.</p>
          <button onclick="app.toggleOledMode()" class="btn-oled" style="width:100%; margin-top:20px">üåë √âCRAN NOIR</button>
          <button onclick="app.stopPunishment()" class="btn-secondary" style="width:100%; margin-top:10px; opacity:0.5">Terminer (Triche)</button>
      </div>
  </div>

  <!-- Param√®tres -->
  <div class="settings-panel" id="settingsPanel">
    <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:#cbd5e1">Num√©ro WhatsApp</label>
    <input type="text" id="phoneInput" value="33783204184" onchange="app.saveSettings()">
    <div class="checkbox-row">
      <label class="checkbox-label"><input type="checkbox" id="checkSound" checked onchange="app.saveSettings()"> Son</label>
      <label class="checkbox-label"><input type="checkbox" id="checkVib" checked onchange="app.saveSettings()"> Vib</label>
    </div>
    <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#64748b">
       Total Sessions: <span id="stTotal">0</span>
    </div>
  </div>
</main>

<div id="toast" class="toast">Info</div>

<script>
/** AUDIO ENGINE */
const SoundEngine = {
  ctx: null,
  init() {
    if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (this.ctx.state === 'suspended') this.ctx.resume();
  },
  beep(startTime, duration, freq, type='square') {
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, startTime);
    gain.gain.setValueAtTime(0.3, startTime);
    gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start(startTime);
    osc.stop(startTime + duration);
  },
  playAlarmSequence() {
    this.init();
    const now = this.ctx.currentTime;
    // Agressive alarm
    for(let i=0; i<6; i++) { 
        this.beep(now + i*0.8, 0.1, 800); 
        this.beep(now + i*0.8 + 0.15, 0.1, 800); 
        this.beep(now + i*0.8 + 0.3, 0.4, 600); 
    }
  }
};

/** LOGIC v6.1 */
const app = {
  state: {
    phase: 'idle', 
    startTime: 0,
    elapsed: 0,
    targetDuration: 0,
    timerId: null,
    level: 0,
    wakeLock: null,
    alarmInt: null,
    settings: { phone: '33783204184', sound: true, vib: true, date: true, warmup: false, stretch: false },
    stats: { total: 0, success: 0 },
    extensions: 0,
    punishmentEnd: null
  },
  
  els: {
    statusIcon: document.getElementById('statusIcon'),
    statusText: document.getElementById('statusText'),
    elapsed: document.getElementById('elapsedTime'),
    phaseBadge: document.getElementById('phaseBadge'),
    statusPanel: document.getElementById('statusPanel'),
    coachBox: document.getElementById('coachBox'),
    coachText: document.getElementById('coachText'),
    views: {
      levels: document.getElementById('view-levels'),
      running: document.getElementById('view-running'),
      result: document.getElementById('view-result'),
      sleepSetup: document.getElementById('view-sleep-setup'),
      sleepRun: document.getElementById('view-sleep-run'),
      sleepReport: document.getElementById('view-sleep-report'),
      punishment: document.getElementById('view-punishment')
    },
    inputs: {
      phone: document.getElementById('phoneInput'),
      sound: document.getElementById('checkSound'),
      vib: document.getElementById('checkVib'),
      wakeup: document.getElementById('wakeupTime')
    },
    alert: {
        layer: document.getElementById('alertLayer'),
        icon: document.getElementById('alertIcon'),
        title: document.getElementById('alertTitle'),
        msg: document.getElementById('alertMsg')
    },
    punishMsg: document.getElementById('punish-msg'),
    punishTimer: document.getElementById('punish-timer'),
    modal: document.getElementById('choiceModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalText: document.getElementById('modalText'),
    modalBtnYes: document.getElementById('modalBtnYes'),
    modalBtnNo: document.getElementById('modalBtnNo'),
    whatsappArea: document.getElementById('whatsapp-area'),
    memoCharge: document.getElementById('memoCharge'),
    settingsPanel: document.getElementById('settingsPanel')
  },

  init() {
    this.loadSettings();
    document.getElementById('stTotal').textContent = this.state.stats.total;
    this.requestWakeLock();
    this.resetUI();
    
    // Set default wakeup to next morning 7:00
    this.els.inputs.wakeup.value = "07:00";
    
    let lastTap = 0;
    const handleDouble = () => {
        const currentTime = new Date().getTime();
        if (currentTime - lastTap < 500) this.toggleOledMode();
        lastTap = currentTime;
    };
    document.getElementById('oledTouchArea').addEventListener('click', handleDouble);
    this.els.alert.layer.addEventListener('click', () => this.stopAlert());
  },

  // --- CORE TRAINING ---
  triggerSelection(lvl) {
      this.state.level = lvl;
      this.showModal(
          "üî• √âchauffement ?",
          "L'entra√Æneur recommande de pr√©parer le corps.",
          () => { this.state.settings.warmup = true; this.startTrainingSequence(); },
          () => { this.state.settings.warmup = false; this.startTrainingSequence(); }
      );
  },

  startTrainingSequence() {
      this.els.modal.style.display = 'none';
      
      // Calc duration
      let mainDur = 0;
      switch(this.state.level) {
        case 1: mainDur = this.rand(2, 5); break;
        case 2: mainDur = this.rand(4, 7); break;
        case 3: mainDur = this.rand(7, 9); break;
        case 4: mainDur = 9 * 3600000; break;
        case 5: mainDur = this.rand(2, 9); break;
      }
      
      this.state.extensions = 0;
      
      if(this.state.settings.warmup) {
          this.state.nextMainDur = mainDur; // Store for later
          this.startPhase('warmup', this.rand(20, 30) * 60000); // 20-30 min warmup
      } else {
          this.startPhase('training', mainDur);
      }
  },

  startPhase(phaseName, durationMs) {
    this.state.phase = phaseName;
    this.state.targetDuration = durationMs;
    this.state.startTime = Date.now();
    this.state.elapsed = 0;
    
    this.updateUIForPhase(phaseName);
    this.showView('running');
    this.els.statusPanel.classList.add('active-ring');
    
    if (this.state.timerId) clearInterval(this.state.timerId);
    this.state.timerId = setInterval(() => this.tick(), 1000);
    this.requestWakeLock();
  },

  tick() {
    const now = Date.now();
    this.state.elapsed = now - this.state.startTime;
    
    // Reverse countdown for Sleep & Punishment
    if(this.state.phase === 'sleep' || this.state.phase === 'punishment') {
        const remaining = Math.max(0, this.state.targetDuration - this.state.elapsed);
        if(this.state.phase === 'sleep') {
            // Nothing special, just wait for 0
        } 
        if(this.state.phase === 'punishment') {
            this.els.punishTimer.textContent = this.formatTime(remaining);
        } else {
            this.els.elapsed.textContent = this.formatTime(remaining);
        }
        
        if (remaining <= 0) {
            if(this.state.phase === 'sleep') this.triggerSleepAlarm();
            else this.triggerAlertLogic();
        }
    } 
    // Normal Countup for training
    else {
        this.els.elapsed.textContent = this.formatTime(this.state.elapsed);
        if (this.state.elapsed >= this.state.targetDuration) {
            this.triggerAlertLogic();
        }
    }
  },

  addRunningTime(minutes) {
      this.state.targetDuration += minutes * 60000;
      this.state.extensions += minutes;
      this.toast(`Temps ajout√© : +${minutes} min`);
  },

  extendSession(minutes) {
      if(!confirm(`Confirmer ajout ${minutes} min ? Engagement d√©finitif.`)) return;
      this.state.targetDuration += minutes * 60000;
      this.state.extensions += minutes;
      this.state.startTime = Date.now() - this.state.elapsed; // Reset start base
      this.startPhase('training', this.state.targetDuration); // Resume
  },

  triggerAlertLogic() {
    clearInterval(this.state.timerId);
    if (document.body.classList.contains('oled-mode')) this.toggleOledMode();

    this.els.alert.layer.classList.add('active');
    
    if(this.state.phase === 'punishment') {
        this.els.alert.title.textContent = "MATIN ARIV√â";
        this.els.alert.msg.textContent = "Punition termin√©e. Tu peux disposer.";
    } else {
        this.els.alert.title.textContent = "TERMIN√â";
        this.els.alert.msg.textContent = "Appuyez pour valider";
    }

    if(this.state.settings.sound) {
        SoundEngine.playAlarmSequence();
        this.state.alarmInt = setInterval(() => SoundEngine.playAlarmSequence(), 5000);
    }
    if(this.state.settings.vib && navigator.vibrate) navigator.vibrate([500, 500, 500]);
  },

  stopAlert() {
    this.els.alert.layer.classList.remove('active');
    clearInterval(this.state.alarmInt);
    this.els.statusPanel.classList.remove('active-ring');
    
    if(this.state.phase === 'warmup') {
        this.setCoachMessage("√âchauffement termin√©. Place √† l'entra√Ænement.");
        setTimeout(() => this.startPhase('training', this.state.nextMainDur), 2000);
    } else if (this.state.phase === 'training') {
        this.showResultScreen();
    } else if (this.state.phase === 'punishment') {
        this.resetUI();
    }
  },

  showResultScreen() {
      this.showView('result');
      this.els.statusText.textContent = "Pause";
      this.els.extensionArea.style.display = 'block';
      this.els.whatsappArea.classList.add('hidden');
  },

  finish(success) {
      this.state.stats.total++;
      if(success) this.state.stats.success++;
      this.saveSettings();
      this.els.extensionArea.style.display = 'none';
      this.els.whatsappArea.classList.remove('hidden');
  },

  triggerWhatsapp() {
      // Basic report logic
      let cleanPhone = this.state.settings.phone.replace(/[^0-9]/g, '');
      let msg = `*Rapport Porte v6*\n‚è±Ô∏è Total: ${this.formatTime(this.state.elapsed)}\n`;
      if(this.state.extensions > 0) msg += `‚ú® Bonus: +${this.state.extensions} min\n`;
      msg += `üìÖ ${new Date().toLocaleString()}`;
      window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
  },

  // --- SLEEP DISCIPLINE MODULE ---

  setupSleepPunishment(mode) {
      if(mode === 'nuitblanche') {
          // Direct Nuit Blanche
          this.els.punishMsg.textContent = "C‚Äôest parti pour une nuit enti√®re sans sommeil √† regarder cette porte, debout comme une merde pendant que les autres dorment.";
          this.showView('sleepReport'); // Go to time selection to set wakeup
      } else {
          // Challenge
          this.showView('sleepSetup');
      }
  },

  startSleepTimer(minutes) {
      this.setCoachMessage(`Si tu ne dors pas dans les ${minutes} mn, tu reviens ici et tu seras puni.`);
      this.startPhase('sleep', minutes * 60000);
      this.showView('sleepRun');
      this.els.statusPanel.classList.remove('active-ring'); // Silent mode visually
  },

  triggerSleepAlarm() {
      // Timer ended -> Wake up -> Fail
      clearInterval(this.state.timerId);
      if (document.body.classList.contains('oled-mode')) this.toggleOledMode();
      
      SoundEngine.playAlarmSequence();
      this.state.alarmInt = setInterval(() => SoundEngine.playAlarmSequence(), 4000);
      
      if(confirm("TEMPS √âCOUL√â !\nTu es r√©veill√© ?\n\nSi tu entends √ßa, tu as √©chou√©.")) {
          this.failSleep('timer');
      }
  },

  failSleep(reason) {
      clearInterval(this.state.alarmInt); // Stop alarm if ringing
      clearInterval(this.state.timerId); // Stop timer if manual fail
      
      this.showView('sleepReport');
      
      let msg = "";
      if(reason === 'voluntary') {
          msg = "Signalement : Trop excit√© ou douloureux. Impossible de dormir.";
      } else {
          msg = "Signalement : Le temps est √©coul√© et je suis encore √©veill√©.";
      }
      this.els.punishMsg.textContent = msg + " Je m√©rite d'√™tre puni.";
  },

  calculatePunishment() {
      const wakeStr = this.els.inputs.wakeup.value; // "07:00"
      if(!wakeStr) return alert("Indique l'heure de r√©veil !");

      const now = new Date();
      let wakeDate = new Date();
      const [h, m] = wakeStr.split(':');
      wakeDate.setHours(h, m, 0, 0);

      if(wakeDate < now) {
          wakeDate.setDate(wakeDate.getDate() + 1); // Next day
      }

      const diff = wakeDate - now;
      if(diff <= 0) return alert("Heure invalide (d√©j√† pass√©e)");

      // Textes punitifs
      let txt = "Puisque tu es incapable de t‚Äôendormir, le mieux c‚Äôest que tu finisses la nuit debout devant la porte.\n\n";
      txt += "Poses ton t√©l√©phone. Oublie ton lit, oublie ton besoin de dormir. Reprends ta position et garde la jusqu‚Äôau bout avec tes pieds bien √† plat, le corps droit, les bras le long du corps ou derri√®re le dos, le regard fixe droit devant toi.\n\n";
      txt += "C'est ton devoir. Ob√©is sans d√©lai.";

      this.els.punishMsg.innerText = txt;
      
      // Start Punishment Timer
      document.body.classList.add('mode-punish');
      this.startPhase('punishment', diff);
      this.showView('punishment');
  },

  stopPunishment() {
      if(confirm("Arr√™ter la punition (Triche) ?")) {
          document.body.classList.remove('mode-punish');
          this.resetUI();
      }
  },

  // --- UTILS ---

  showView(viewName) {
    Object.values(this.els.views).forEach(el => el.classList.add('hidden'));
    this.els.views[viewName].classList.remove('hidden');
    
    // Status Panel Visibility
    if(viewName === 'levels' || viewName === 'running' || viewName === 'sleepRun') {
        this.els.statusPanel.style.display = 'block';
    } else {
        this.els.statusPanel.style.display = 'none';
    }

    // Settings Visibility
    this.els.settingsPanel.style.display = (viewName === 'levels') ? 'block' : 'none';
    this.els.memoCharge.style.display = (viewName === 'levels') ? 'block' : 'none';
  },

  updateUIForPhase(p) {
    this.els.statusPanel.classList.remove('active-ring');
    if(p === 'warmup') {
      this.els.statusIcon.textContent = 'üî•';
      this.els.statusText.textContent = '√âchauffement';
      this.setCoachMessage("Pr√©pare tes pieds.");
    } else if (p === 'training') {
      this.els.statusIcon.textContent = 'üö™';
      this.els.statusText.textContent = 'GARDE';
      this.setCoachMessage("Reste vigilant. Silence.");
    } else if (p === 'sleep') {
      this.els.statusIcon.textContent = 'üí§';
      this.els.statusText.textContent = 'DORS !';
    } else if (p === 'punishment') {
      this.els.statusIcon.textContent = 'üíÄ';
      this.els.statusText.textContent = 'PUNITION';
    }
  },

  resetUI() {
    this.state.phase = 'idle';
    document.body.classList.remove('mode-punish');
    this.showView('levels');
    this.els.statusIcon.textContent = '‚è±Ô∏è';
    this.els.statusText.textContent = 'Pr√™t';
    this.els.elapsed.textContent = '00:00:00';
    this.setCoachMessage(""); 
  },

  setCoachMessage(msg) {
      if(msg) {
          this.els.coachText.textContent = msg;
          this.els.coachBox.style.display = 'block';
      } else {
          this.els.coachBox.style.display = 'none';
      }
  },

  showModal(title, text, onYes, onNo) {
      this.els.modalTitle.textContent = title;
      this.els.modalText.textContent = text;
      this.els.modal.style.display = 'flex';
      this.els.modalBtnYes.onclick = onYes;
      this.els.modalBtnNo.onclick = onNo;
  },

  saveSettings() {
    const s = {
      phone: this.els.inputs.phone.value,
      sound: this.els.inputs.sound.checked,
      vib: this.els.inputs.vib.checked,
      stats: this.state.stats
    };
    localStorage.setItem('gd_porte_v6', JSON.stringify(s));
  },

  loadSettings() {
    const data = localStorage.getItem('gd_porte_v6');
    if(data) {
      const s = JSON.parse(data);
      if(s.phone) this.els.inputs.phone.value = s.phone;
      this.els.inputs.sound.checked = s.sound;
      this.els.inputs.vib.checked = s.vib;
      if(s.stats) this.state.stats = s.stats;
    }
  },

  toggleOledMode() {
    document.body.classList.toggle('oled-mode');
  },

  async requestWakeLock() {
    try { if ('wakeLock' in navigator) this.state.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
  },

  formatTime(ms) {
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    return `${h}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
  },
  
  rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; },

  toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
};

app.init();
</script>
</body>
</html>
