<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Garde Debout Strict v3.3</title>
  <style>
    :root {
      --primary: #3b82f6; 
      --success: #10b981; 
      --danger: #ef4444; 
      --warning: #f59e0b;
      --text-main: #e2e8f0; 
      --text-muted: #94a3b8;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; margin: 0;
      background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
      color: var(--text-main); font-family: system-ui, -apple-system, sans-serif;
      padding: 16px; 
      overflow-x: hidden;
    }

    /* Mode OLED / √âconomie */
    body.oled-mode { background: #000000; }
    body.oled-mode .card, body.oled-mode h1, body.oled-mode p { opacity: 0; pointer-events: none; }
    body.oled-mode .oled-overlay { display: flex; }

    .oled-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #000; z-index: 9999;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      color: #333;
    }
    .oled-touch-area { width: 100%; height: 100%; position: absolute; }
    .oled-icon { font-size: 4rem; opacity: 0.15; animation: breathe 4s infinite; }

    .card {
      width: min(600px, 100%);
      background: rgba(30, 41, 59, 0.85);
      padding: 24px; border-radius: 20px;
      box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding-bottom: 40px;
    }

    h1 { margin: 0 0 4px; font-size: 1.6rem; text-align: center; background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    p.subtitle { margin: 0 0 20px; color: var(--text-muted); font-size: 0.9rem; text-align: center; }

    /* Layout */
    .status-display { 
        text-align: center; margin: 0 0 20px; padding: 20px; 
        border-radius: 16px; background: rgba(59, 130, 246, 0.05); 
        border: 1px solid rgba(59, 130, 246, 0.1); 
        position: relative; overflow: hidden; 
    }
    
    .status-icon { font-size: 50px; display: block; margin-bottom: 5px; }
    .status-text { font-size: 1.2rem; font-weight: 600; color: #60a5fa; margin-bottom: 4px; }
    .elapsed-time { font-family: monospace; font-size: 1.8rem; letter-spacing: 1px; color: var(--text-main); font-weight: 700; }
    
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
    .active-ring::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--primary); animation: pulse-ring 2s infinite; pointer-events: none; }

    /* Boutons */
    .btn-grid { display: flex; flex-direction: column; gap: 12px; }
    button {
      padding: 16px 20px; border-radius: 14px; border: none; cursor: pointer;
      font-weight: 600; font-size: 1.05rem; color: white; 
      display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      touch-action: manipulation;
    }
    button:active { transform: scale(0.96); }
    
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); color: #1e293b; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text-main); }
    .btn-night { background: linear-gradient(135deg, #4c1d95, #7c3aed); }
    .btn-oled { background: #000; border: 1px solid #333; margin-top: 10px; }
    
    .badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; margin-left: auto; }

    /* Options & Settings */
    .settings-panel { margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    input[type=text] { width: 100%; background: rgba(15,23,42,0.6); border: 1px solid rgba(255,255,255,0.1); padding: 14px; border-radius: 10px; color: white; margin-bottom: 12px; font-size: 1rem; }
    
    .checkbox-row { display: flex; justify-content: space-around; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted); }
    .checkbox-label { display: flex; align-items: center; gap: 8px; padding: 5px; }
    input[type="checkbox"] { transform: scale(1.3); accent-color: var(--primary); }

    .program-options {
        background: rgba(59, 130, 246, 0.1);
        padding: 15px; border-radius: 12px;
        margin-bottom: 20px; border: 1px solid rgba(59, 130, 246, 0.2);
        display: flex; flex-direction: column; gap: 10px;
    }

    /* Alerts */
    .fullscreen-alert {
      position: fixed; inset: 0; background: var(--danger); z-index: 10000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      display: none; padding: 20px;
    }
    .fullscreen-alert.active { display: flex; animation: flash 0.5s infinite; }
    .fullscreen-alert.soft-active { display: flex; background: var(--warning); }
    
    .alert-content { background: white; color: black; padding: 30px; width: 100%; max-width: 400px; border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.15; } 50% { transform: scale(1.1); opacity: 0.3; } }

    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #334155; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: 0.3s; z-index: 10001; width: max-content; }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="alertLayer" class="fullscreen-alert">
  <div class="alert-content">
    <div style="font-size: 60px;" id="alertIcon">üîî</div>
    <h2 style="font-size: 1.8rem; margin: 10px 0;" id="alertTitle">TERMIN√â</h2>
    <p id="alertMsg">Appuyez pour continuer</p>
  </div>
</div>

<div id="oledOverlay" class="oled-overlay">
  <div class="oled-touch-area" id="oledTouchArea"></div>
  <div class="oled-icon">üõ°Ô∏è</div>
  <p style="color: #444; margin-top: 20px;">Double-clic pour r√©veiller</p>
</div>

<main class="card">
  <h1>üõ°Ô∏è Garde Debout (Strict)</h1>
  <p class="subtitle">v3.3 ‚Ä¢ Pas de pause ‚Ä¢ Rapport WhatsApp</p>

  <div id="statusPanel" class="status-display">
    <div class="status-icon" id="statusIcon">‚è±Ô∏è</div>
    <div class="status-text" id="statusText">En attente</div>
    <div class="elapsed-time" id="elapsedTime">00:00:00</div>
    <div id="phaseBadge" style="margin-top:8px; font-size:0.8rem; opacity:0.7">Pr√™t √† d√©marrer</div>
  </div>

  <div id="view-levels">
    <div class="program-options">
        <label class="checkbox-label">
            <input type="checkbox" id="optWarmup" onchange="app.saveSettings()"> 
            <span>üî• + √âchauffement (20-45m)</span>
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="optStretch" onchange="app.saveSettings()"> 
            <span>üßò + √âtirements (Fin)</span>
        </label>
    </div>

    <div class="btn-grid">
        <button onclick="app.selectLevel(1)" class="btn-primary">Niveau 1 <span class="badge">2-5h</span></button>
        <button onclick="app.selectLevel(2)" class="btn-primary">Niveau 2 <span class="badge">4-7h</span></button>
        <button onclick="app.selectLevel(3)" class="btn-primary">Niveau 3 <span class="badge">7-9h</span></button>
        <button onclick="app.selectLevel(4)" class="btn-primary">Niveau 4 <span class="badge">9h Fixe</span></button>
        <button onclick="app.selectLevel(5)" class="btn-night">Niveau 5 <span class="badge">2-9h Chaos</span></button>
    </div>
  </div>

  <div id="view-running" class="btn-grid hidden">
    <button onclick="app.toggleOledMode()" class="btn-oled" style="height: 100px; font-size: 1.2rem;">
        üåë √âTEINDRE √âCRAN<br>
        <span style="font-size:0.8rem; font-weight:normal; color:#888; margin-top:5px">(√âconomie Batterie)</span>
    </button>
    
    <div style="text-align:center; color:#ef4444; font-size:0.8rem; margin:10px 0; opacity:0.8">‚ö†Ô∏è Mode Strict : Pause d√©sactiv√©e</div>

    <button onclick="app.confirmStop()" class="btn-danger">üõë Abandonner</button>
  </div>

  <div id="view-result" class="btn-grid hidden">
    <p style="text-align:center; color:white; font-size:1.1rem">R√©sultat de la Garde ?</p>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
      <button onclick="app.finish(true)" class="btn-success" style="height:70px">‚úÖ R√©ussi</button>
      <button onclick="app.finish(false)" class="btn-danger" style="height:70px">‚ùå √âchec</button>
    </div>
    <button onclick="app.finish(null)" class="btn-secondary">‚ö†Ô∏è Partiel / Ne pas noter</button>
  </div>

  <div id="view-night" class="btn-grid hidden">
    <div style="text-align:center; margin-bottom:15px; color:#a78bfa">Garde longue d√©tect√©e.<br>Voulez-vous encha√Æner ?</div>
    <button onclick="app.startNightSession()" class="btn-night">üåô Lancer Nocturne (1-3h)</button>
    <button onclick="app.resetUI()" class="btn-secondary">üèÅ Non, terminer la s√©ance</button>
  </div>

  <div class="settings-panel">
    <label style="display:block; margin-bottom:8px; font-size:0.9rem; color:#cbd5e1">Num√©ro WhatsApp (sans +)</label>
    <input type="text" id="phoneInput" value="33683204184" onchange="app.saveSettings()">
    
    <div class="checkbox-row">
      <label class="checkbox-label"><input type="checkbox" id="checkSound" checked onchange="app.saveSettings()"> Son</label>
      <label class="checkbox-label"><input type="checkbox" id="checkVib" checked onchange="app.saveSettings()"> Vib</label>
      <label class="checkbox-label"><input type="checkbox" id="checkDate" checked onchange="app.saveSettings()"> Date</label>
    </div>

    <button onclick="app.testAlerts()" class="btn-secondary" style="font-size:0.9rem; padding:10px">üîî Tester Sonneries</button>
    <div style="text-align:center; margin-top:15px; font-size:0.8rem; color:#64748b">
       Total: <span id="stTotal" style="color:#fff">0</span> | Succ√®s: <span id="stRate" style="color:#fff">0%</span>
    </div>
  </div>
</main>

<div id="toast" class="toast">Info</div>

<script>
/**
 * AUDIO ENGINE
 */
const SoundEngine = {
  ctx: null,
  init() {
    if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (this.ctx.state === 'suspended') this.ctx.resume();
  },
  beep(startTime, duration, freq, type='square') {
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, startTime);
    gain.gain.setValueAtTime(0.3, startTime);
    gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
    osc.connect(gain);
    gain.connect(this.ctx.destination);
    osc.start(startTime);
    osc.stop(startTime + duration);
  },
  // ALARME 5 BIPS (Garde)
  playAlarmSequence() {
    this.init();
    const now = this.ctx.currentTime;
    for(let i=0; i<5; i++) {
        this.beep(now + i, 0.4, 880); 
    }
  },
  // SIGNAL 2 BIPS (Transition)
  playDoubleBeep() {
    this.init();
    const now = this.ctx.currentTime;
    this.beep(now, 0.2, 600, 'sine');       
    this.beep(now + 0.3, 0.2, 600, 'sine'); 
  }
};

/**
 * LOGIC v3.3 (NO PAUSE)
 */
const app = {
  state: {
    phase: 'idle', 
    startTime: 0,
    elapsed: 0,
    targetDuration: 0,
    timerId: null,
    level: 0,
    wakeLock: null,
    alarmInt: null,
    settings: { phone: '33683204184', sound: true, vib: true, date: true, warmup: false, stretch: false },
    stats: { total: 0, success: 0, lastDur: 0 }
  },
  
  els: {
    statusIcon: document.getElementById('statusIcon'),
    statusText: document.getElementById('statusText'),
    elapsed: document.getElementById('elapsedTime'),
    phaseBadge: document.getElementById('phaseBadge'),
    statusPanel: document.getElementById('statusPanel'),
    views: {
      levels: document.getElementById('view-levels'),
      running: document.getElementById('view-running'),
      result: document.getElementById('view-result'),
      night: document.getElementById('view-night')
    },
    inputs: {
      phone: document.getElementById('phoneInput'),
      sound: document.getElementById('checkSound'),
      vib: document.getElementById('checkVib'),
      date: document.getElementById('checkDate'),
      warmup: document.getElementById('optWarmup'),
      stretch: document.getElementById('optStretch')
    },
    alert: {
        layer: document.getElementById('alertLayer'),
        icon: document.getElementById('alertIcon'),
        title: document.getElementById('alertTitle'),
        msg: document.getElementById('alertMsg')
    },
    oled: document.getElementById('oledOverlay')
  },

  init() {
    this.loadSettings();
    this.updateStatsUI();
    
    let lastTap = 0;
    document.getElementById('oledTouchArea').addEventListener('click', (e) => {
      const currentTime = new Date().getTime();
      if (currentTime - lastTap < 500) this.toggleOledMode();
      lastTap = currentTime;
    });

    this.els.alert.layer.addEventListener('click', () => this.stopAlert());
  },

  saveSettings() {
    const s = {
      phone: this.els.inputs.phone.value,
      sound: this.els.inputs.sound.checked,
      vib: this.els.inputs.vib.checked,
      date: this.els.inputs.date.checked,
      warmup: this.els.inputs.warmup.checked,
      stretch: this.els.inputs.stretch.checked,
      stats: this.state.stats
    };
    localStorage.setItem('gd_settings_v3_3', JSON.stringify(s));
    this.state.settings = s;
  },

  loadSettings() {
    const data = localStorage.getItem('gd_settings_v3_3');
    if(data) {
      const s = JSON.parse(data);
      if(s.phone) this.els.inputs.phone.value = s.phone;
      this.els.inputs.sound.checked = s.sound;
      this.els.inputs.vib.checked = s.vib;
      this.els.inputs.date.checked = s.date;
      this.els.inputs.warmup.checked = s.warmup;
      this.els.inputs.stretch.checked = s.stretch;
      if(s.stats) this.state.stats = s.stats;
      this.state.settings = s;
    }
  },

  updateStatsUI() {
    document.getElementById('stTotal').textContent = this.state.stats.total;
    const rate = this.state.stats.total > 0 ? Math.round((this.state.stats.success / this.state.stats.total) * 100) : 0;
    document.getElementById('stRate').textContent = rate + '%';
  },

  rand(minH, maxH) { return Math.floor(Math.random() * (maxH*3600000 - minH*3600000 + 1)) + minH*3600000; },

  selectLevel(lvl) {
    SoundEngine.init(); 
    this.state.level = lvl;
    if (this.state.settings.warmup) this.startPhase('warmup', this.rand(0.3, 0.75)); 
    else this.startMainTraining();
  },

  startMainTraining() {
      let dur = 0;
      switch(this.state.level) {
        case 1: dur = this.rand(2, 5); break;
        case 2: dur = this.rand(4, 7); break;
        case 3: dur = this.rand(7, 9); break;
        case 4: dur = 9 * 3600000; break;
        case 5: dur = this.rand(2, 9); break;
      }
      this.startPhase('training', dur);
  },

  startPhase(phaseName, durationMs) {
    this.state.phase = phaseName;
    this.state.targetDuration = durationMs;
    this.state.startTime = Date.now();
    this.state.elapsed = 0;
    
    this.updateUIForPhase(phaseName);
    this.showView('running');
    this.els.statusPanel.classList.add('active-ring');
    
    if (this.state.timerId) clearInterval(this.state.timerId);
    this.state.timerId = setInterval(() => this.tick(), 1000);
    this.requestWakeLock();
  },

  tick() {
    // PLUS DE PAUSE ICI
    const now = Date.now();
    this.state.elapsed = now - this.state.startTime;
    this.els.elapsed.textContent = this.formatTime(this.state.elapsed);

    if (this.state.elapsed >= this.state.targetDuration) {
      this.triggerAlertLogic();
    }
  },

  triggerAlertLogic() {
    clearInterval(this.state.timerId);
    if (document.body.classList.contains('oled-mode')) this.toggleOledMode();

    const isMain = (this.state.phase === 'training' || this.state.phase === 'night');
    
    this.els.alert.layer.classList.add(isMain ? 'active' : 'soft-active');
    this.els.alert.title.textContent = isMain ? "GARDE TERMIN√âE" : "PHASE TERMIN√âE";
    this.els.alert.icon.textContent = isMain ? "üîî" : "üëå";
    this.els.alert.msg.textContent = isMain ? "STOP ! Appuyez pour valider" : "Appuyez pour la suite";

    if(this.state.settings.sound) {
        if(isMain) {
            SoundEngine.playAlarmSequence();
            this.state.alarmInt = setInterval(() => SoundEngine.playAlarmSequence(), 7000);
        } else {
            SoundEngine.playDoubleBeep();
            this.state.alarmInt = setInterval(() => SoundEngine.playDoubleBeep(), 5000);
        }
    }

    if(this.state.settings.vib && navigator.vibrate) {
        navigator.vibrate(isMain ? [500, 500, 500] : [200, 100, 200]);
    }
  },

  stopAlert() {
    this.els.alert.layer.classList.remove('active', 'soft-active');
    clearInterval(this.state.alarmInt);
    this.els.statusPanel.classList.remove('active-ring');
    this.transitionToNext();
  },

  testAlerts() {
    this.toast('Test: 2 Bips puis 5 Bips');
    SoundEngine.playDoubleBeep();
    setTimeout(() => SoundEngine.playAlarmSequence(), 2000);
  },

  transitionToNext() {
    const p = this.state.phase;
    
    if (p === 'warmup') {
      this.toast("Fin √©chauffement. D√©marrage garde...");
      setTimeout(() => this.startMainTraining(), 500);
      
    } else if (p === 'training') {
      this.state.stats.lastDur = this.state.elapsed; 
      
      if (this.state.settings.stretch) {
          this.toast("Garde finie. Place aux √©tirements...");
          setTimeout(() => this.startPhase('stretching', this.rand(0.3, 0.75)), 500);
      } else {
          this.showView('result');
          this.els.statusText.textContent = 'Termin√©';
      }

    } else if (p === 'stretching') {
      this.toast("S√©ance compl√®te termin√©e.");
      this.showView('result');
      this.els.statusText.textContent = 'Termin√©';
      
    } else if (p === 'night') {
      this.showView('result');
    }
  },

  finish(success) {
    if (success !== null) {
        this.state.stats.total++;
        if (success) this.state.stats.success++;
        this.saveSettings();
        this.updateStatsUI();
        // ENVOI WHATSAPP
        this.sendReport(success);
    }
    
    if(this.state.phase !== 'night' && this.state.stats.lastDur > 2*3600000) {
        this.showView('night');
    } else {
        this.resetUI();
    }
  },

  // MODULE WHATSAPP
  sendReport(success) {
    let cleanPhone = this.state.settings.phone.replace(/[^0-9]/g, '');
    if(!cleanPhone) cleanPhone = "33683204184"; // Fallback au cas o√π

    let type = this.state.phase === 'night' ? 'üåô Nocturne' : 'üö™ Garde Debout';
    if(this.state.settings.stretch && this.state.phase !== 'night') type += ' + √âtirements';
    
    let status = success ? '‚úÖ SUCC√àS' : '‚ùå √âCHEC';
    let dur = this.formatTime(this.state.stats.lastDur);
    let date = this.state.settings.date ? `üìÖ ${new Date().toLocaleString()}` : '';
    
    let msg = `*Rapport Garde*\n${type}\nDur√©e Garde: ${dur}\nR√©sultat: ${status}\n${date}`;
    
    window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
  },

  startNightSession() {
    this.startPhase('night', this.rand(1, 3));
    this.els.statusIcon.textContent = 'üåô';
  },

  toggleOledMode() {
    document.body.classList.toggle('oled-mode');
    if(document.body.classList.contains('oled-mode')) this.toast('Double-clic pour rallumer');
  },

  async requestWakeLock() {
    try { if ('wakeLock' in navigator) this.state.wakeLock = await navigator.wakeLock.request('screen'); } 
    catch (e) {}
  },

  showView(viewName) {
    Object.values(this.els.views).forEach(el => el.classList.add('hidden'));
    this.els.views[viewName].classList.remove('hidden');
  },

  updateUIForPhase(p) {
    if(p === 'warmup') {
      this.els.statusIcon.textContent = 'üî•';
      this.els.statusText.textContent = '√âchauffement';
      this.els.phaseBadge.textContent = 'Pr√©paration al√©atoire';
    } else if (p === 'training') {
      this.els.statusIcon.textContent = 'üö™';
      this.els.statusText.textContent = 'EN GARDE';
      this.els.phaseBadge.textContent = 'Restez vigilant...';
    } else if (p === 'stretching') {
      this.els.statusIcon.textContent = 'üßò';
      this.els.statusText.textContent = '√âtirements';
      this.els.phaseBadge.textContent = 'R√©cup√©ration al√©atoire';
    } else if (p === 'night') {
      this.els.statusText.textContent = 'Nocturne';
    }
  },

  resetUI() {
    this.state.phase = 'idle';
    this.showView('levels');
    this.els.statusIcon.textContent = '‚è±Ô∏è';
    this.els.statusText.textContent = 'Pr√™t';
    this.els.elapsed.textContent = '00:00:00';
    this.els.phaseBadge.textContent = 'En attente';
    this.els.statusPanel.classList.remove('active-ring');
  },

  confirmStop() {
    if(confirm("Abandonner ?")) {
      clearInterval(this.state.timerId);
      this.els.statusPanel.classList.remove('active-ring');
      this.resetUI();
    }
  },

  formatTime(ms) {
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    return `${h}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
  },
  
  toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
};

app.init();
</script>
</body>
</html>
